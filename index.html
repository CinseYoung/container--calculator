<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dé›†è£…ç®±è£…ç®±è®¡ç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .help-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .help-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
        }

        .content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 0;
            min-height: 900px;
        }

        .input-panel {
            background: #f8f9fa;
            padding: 25px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .box-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .box-item:hover {
            border-color: #667eea;
        }

        .box-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            cursor: grabbing;
        }

        .box-item.drag-over {
            border-color: #28a745;
            border-style: dashed;
            background: #f0fff4;
        }

        .drag-handle {
            cursor: grab;
            color: #999;
            font-size: 18px;
            padding: 0 8px;
            user-select: none;
        }

        .drag-handle:hover {
            color: #667eea;
        }

        .box-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* ç­–ç•¥é€‰æ‹©ä¸‹æ‹‰æ¡† */
        .strategy-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .strategy-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .strategy-desc {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 6px;
            line-height: 1.5;
        }

        .color-indicator {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .visualization-panel {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        #canvas-container {
            flex: 1;
            background: #f0f0f0;
            border-radius: 15px;
            position: relative;
            min-height: 500px;
            margin-bottom: 20px;
        }

        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #555;
        }

        .result-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .legend-item:hover {
            background: #e9ecef;
        }

        .legend-item.active {
            border-color: #667eea;
        }

        .legend-item.hidden {
            opacity: 0.4;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #333;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 13px;
            color: #555;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .control-btn:hover {
            background: #5568d3;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .loading.active {
            display: block;
        }

        .utilization-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .utilization-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* æ‚¬æµ®æç¤ºæ¡†æ ·å¼ */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }

        .tooltip.visible {
            display: block;
        }

        .tooltip-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .tooltip-label {
            color: #aaa;
        }

        .tooltip-value {
            font-weight: 600;
            color: #4ECDC4;
        }

        /* ä½¿ç”¨è¯´æ˜é¢æ¿ */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .help-modal.visible {
            display: flex;
        }

        .help-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .help-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .help-close:hover {
            color: #333;
        }

        .help-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section p, .help-section ul {
            color: #555;
            line-height: 1.8;
        }

        .help-section ul {
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 5px;
        }

        .help-tip {
            background: #e8f4fd;
            border-left: 4px solid #667eea;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 10px;
        }

        .algorithm-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }

        .legend-panel {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .legend-panel .section-title {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ 3Dé›†è£…ç®±è£…ç®±è®¡ç®—å™¨</h1>
            <button class="help-btn" onclick="showHelp()">ä½¿ç”¨è¯´æ˜</button>
        </div>

        <div class="content">
            <!-- è¾“å…¥é¢æ¿ -->
            <div class="input-panel">
                <!-- é›†è£…ç®±å°ºå¯¸ -->
                <div class="section">
                    <div class="section-title">ğŸš¢ é›†è£…ç®±å°ºå¯¸ (cm)</div>
                    <div class="input-group">
                        <div class="input-row">
                            <div>
                                <label>é•¿åº¦</label>
                                <input type="number" id="container-length" value="1200" min="1">
                            </div>
                            <div>
                                <label>å®½åº¦</label>
                                <input type="number" id="container-width" value="235" min="1">
                            </div>
                            <div>
                                <label>é«˜åº¦</label>
                                <input type="number" id="container-height" value="238" min="1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‘†æ”¾ç­–ç•¥é€‰æ‹© -->
                <div class="section">
                    <div class="section-title">âš™ï¸ æ‘†æ”¾ç­–ç•¥</div>
                    <div class="input-group">
                        <select id="packing-strategy" class="strategy-select" onchange="updateStrategyDesc()">
                            <option value="bottom-left">åº•å±‚ä¼˜å…ˆ (Bottom-Left)</option>
                            <option value="layer">åˆ†å±‚é“ºæ»¡ (Layer Building)</option>
                            <option value="back-front">åå‘å †å  (Back-to-Front)</option>
                            <option value="wall">å¢™æ„å»ºæ³• (Wall Building)</option>
                            <option value="ffd" selected>ä½“ç§¯ä¼˜å…ˆ (FFD)</option>
                            <option value="manual">ç”¨æˆ·é¡ºåº (Manual Order)</option>
                        </select>
                        <div class="strategy-desc" id="strategy-desc">
                            ğŸ“¦ æŒ‰ä½“ç§¯ä»å¤§åˆ°å°æ’åºï¼Œä¼˜å…ˆæ”¾ç½®å¤§ä»¶ç‰©å“ï¼Œç©ºé—´åˆ©ç”¨ç‡æœ€é«˜ã€‚
                        </div>
                    </div>
                </div>

                <!-- æ‘†æ”¾å§¿åŠ¿é€‰æ‹© -->
                <div class="section">
                    <div class="section-title">ğŸ“ æ‘†æ”¾å§¿åŠ¿</div>
                    <div class="input-group">
                        <select id="orientation-mode" class="strategy-select" onchange="updateOrientationDesc()">
                            <option value="free" selected>éšæ„æ‘†æ”¾ (Free Rotation)</option>
                            <option value="upright">ç«‹æ”¾ (Upright Only)</option>
                        </select>
                        <div class="strategy-desc" id="orientation-desc">
                            ğŸ“¦ ç®±å­å¯ä»¥ä»»æ„æ—‹è½¬ï¼ˆ6ç§å§¿æ€ï¼‰ï¼Œè¿½æ±‚æœ€å¤§ç©ºé—´åˆ©ç”¨ç‡ã€‚
                        </div>
                    </div>
                </div>

                <!-- ç®±å­åˆ—è¡¨ -->
                <div class="section">
                    <div class="section-title">ğŸ“¦ è´§ç‰©ç®±å­ <span style="font-size: 12px; color: #888;">ï¼ˆå¯æ‹–æ‹½æ’åºï¼‰</span></div>
                    <div id="boxes-container">
                        <!-- ç®±å­é¡¹å°†åŠ¨æ€æ·»åŠ  -->
                    </div>
                    <button class="btn btn-secondary" onclick="addBox()">â• æ·»åŠ ç®±å­</button>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="section">
                    <button class="btn btn-primary" onclick="calculate()">ğŸ” å¼€å§‹è®¡ç®—</button>
                    <button class="btn btn-success" onclick="exportResults()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                </div>
            </div>

            <!-- å¯è§†åŒ–é¢æ¿ -->
            <div class="visualization-panel">
                <div class="loading" id="loading">æ­£åœ¨è®¡ç®—æœ€ä¼˜æ–¹æ¡ˆ...</div>
                
                <div id="canvas-container">
                    <div class="tooltip" id="tooltip"></div>
                </div>

                <div class="controls">
                    <button class="control-btn" onclick="resetCamera()">ğŸ”„ é‡ç½®è§†è§’</button>
                    <button class="control-btn" onclick="toggleWireframe()">ğŸ”² çº¿æ¡†æ¨¡å¼</button>
                    <button class="control-btn" onclick="toggleAxes()">ğŸ“ åæ ‡è½´</button>
                    <button class="control-btn" onclick="toggleContainer()">ğŸ“¦ é›†è£…ç®±è¾¹æ¡†</button>
                </div>

                <!-- å›¾ä¾‹åŒºåŸŸ - æ”¾åœ¨3Då›¾ä¸‹æ–¹ -->
                <div class="legend-panel" id="legend-panel" style="display: none;">
                    <div class="section-title">ğŸ¨ å›¾ä¾‹ <span style="font-size: 12px; color: #888;">(ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—)</span></div>
                    <div class="legend" id="legend"></div>
                </div>

                <div class="results" id="results" style="display: none;">
                    <div class="section-title">ğŸ“Š è®¡ç®—ç»“æœ <span class="algorithm-badge" id="algorithm-badge">ä½“ç§¯ä¼˜å…ˆ (FFD)</span></div>
                    <div class="result-item">
                        <span class="result-label">ç©ºé—´åˆ©ç”¨ç‡</span>
                        <span class="result-value" id="utilization-rate">0%</span>
                    </div>
                    <div class="utilization-bar">
                        <div class="utilization-fill" id="utilization-fill" style="width: 0%">0%</div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é›†è£…ç®±å®¹ç§¯</span>
                        <span class="result-value" id="container-volume">0 mÂ³</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">å·²ä½¿ç”¨å®¹ç§¯</span>
                        <span class="result-value" id="used-volume">0 mÂ³</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">è£…è½½ç®±å­æ€»æ•°</span>
                        <span class="result-value" id="total-boxes">0</span>
                    </div>

                    <div class="section-title" style="margin-top: 20px;">ğŸ“¦ å„ç±»ç®±å­è£…è½½æƒ…å†µ</div>
                    <div id="box-details"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜å¼¹çª— -->
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <button class="help-close" onclick="hideHelp()">Ã—</button>
            <h2 class="help-title">ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            
            <div class="help-section">
                <h3>ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
                <ol>
                    <li><strong>è®¾ç½®é›†è£…ç®±å°ºå¯¸</strong>ï¼šè¾“å…¥é›†è£…ç®±çš„é•¿ã€å®½ã€é«˜ï¼ˆå•ä½ï¼šå˜ç±³ï¼‰</li>
                    <li><strong>æ·»åŠ è´§ç‰©ç®±å­</strong>ï¼šç‚¹å‡»ã€Œæ·»åŠ ç®±å­ã€æŒ‰é’®ï¼Œè®¾ç½®æ¯ç§ç®±å­çš„å°ºå¯¸å’Œæ•°é‡</li>
                    <li><strong>å¼€å§‹è®¡ç®—</strong>ï¼šç‚¹å‡»ã€Œå¼€å§‹è®¡ç®—ã€æŒ‰é’®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—æœ€ä¼˜è£…ç®±æ–¹æ¡ˆ</li>
                    <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šåœ¨3Dè§†å›¾ä¸­æŸ¥çœ‹è£…ç®±æ•ˆæœï¼Œå¹¶æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</li>
                </ol>
            </div>

            <div class="help-section">
                <h3>ğŸ® 3Dè§†å›¾æ“ä½œ</h3>
                <ul>
                    <li><strong>æ—‹è½¬è§†è§’</strong>ï¼šæŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨</li>
                    <li><strong>ç¼©æ”¾</strong>ï¼šæ»šåŠ¨é¼ æ ‡æ»šè½®</li>
                    <li><strong>å¹³ç§»</strong>ï¼šæŒ‰ä½é¼ æ ‡å³é”®æ‹–åŠ¨</li>
                    <li><strong>æŸ¥çœ‹ç®±å­ä¿¡æ¯</strong>ï¼šå°†é¼ æ ‡æ‚¬åœåœ¨ç®±å­ä¸Š</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>ğŸ¨ å›¾ä¾‹åŠŸèƒ½</h3>
                <p>ç‚¹å‡»å›¾ä¾‹ä¸­çš„ç®±å­ç±»å‹å¯ä»¥<strong>æ˜¾ç¤º/éšè—</strong>å¯¹åº”çš„ç®±å­ï¼Œæ–¹ä¾¿æŸ¥çœ‹ç‰¹å®šç±»å‹ç®±å­çš„åˆ†å¸ƒæƒ…å†µã€‚è¢«éšè—çš„ç®±å­ç±»å‹ä¼šæ˜¾ç¤ºä¸ºåŠé€æ˜çŠ¶æ€ã€‚</p>
            </div>

            <div class="help-section">
                <h3>âš™ï¸ æ‘†æ”¾ç­–ç•¥è¯´æ˜</h3>
                <p>æœ¬å·¥å…·æ”¯æŒ <strong>6ç§æ‘†æ”¾ç­–ç•¥</strong>ï¼Œå¯æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š</p>
                <ul>
                    <li><strong>åº•å±‚ä¼˜å…ˆ (Bottom-Left)</strong>ï¼šä¼˜å…ˆå¡«æ»¡åº•å±‚ç©ºé—´ï¼Œä»åº•éƒ¨å‘ä¸Šå †å ï¼Œç¡®ä¿ç¨³å®šæ€§</li>
                    <li><strong>åˆ†å±‚é“ºæ»¡ (Layer Building)</strong>ï¼šæŒ‰å±‚é“ºæ»¡ï¼Œæ¯å±‚é«˜åº¦ä¸€è‡´ï¼Œæ•´é½åº¦é«˜</li>
                    <li><strong>åå‘å †å  (Back-to-Front)</strong>ï¼šä»é›†è£…ç®±åéƒ¨ï¼ˆæ·±å¤„ï¼‰å¾€å‰å¡«å……ï¼Œæ–¹ä¾¿è£…å¸</li>
                    <li><strong>å¢™æ„å»ºæ³• (Wall Building)</strong>ï¼šä»å·¦åˆ°å³é€é¢æ„å»º"å¢™"ï¼Œé€‚åˆåˆ†åŒºç®¡ç†</li>
                    <li><strong>ä½“ç§¯ä¼˜å…ˆ (FFD)</strong>ï¼šæŒ‰ä½“ç§¯ä»å¤§åˆ°å°æ’åºï¼Œä¼˜å…ˆæ”¾ç½®å¤§ä»¶ï¼Œç©ºé—´åˆ©ç”¨ç‡æœ€é«˜</li>
                    <li><strong>ç”¨æˆ·é¡ºåº (Manual)</strong>ï¼šå®Œå…¨æŒ‰ç…§æ‚¨æ·»åŠ /æ‹–æ‹½çš„é¡ºåºæ”¾ç½®</li>
                </ul>
                <div class="help-tip">
                    ğŸ’¡ <strong>æç¤º</strong>ï¼šå¯æ‹–æ‹½ç®±å­å¡ç‰‡è°ƒæ•´é¡ºåºï¼Œé€‰æ‹©"ç”¨æˆ·é¡ºåº"ç­–ç•¥åæŒ‰æ­¤é¡ºåºè£…ç®±ã€‚
                </div>
            </div>

            <div class="help-section">
                <h3>ğŸ“ æ‘†æ”¾å§¿åŠ¿è¯´æ˜</h3>
                <p>æœ¬å·¥å…·æ”¯æŒ <strong>2ç§æ‘†æ”¾å§¿åŠ¿</strong>ï¼Œé€‚ç”¨äºä¸åŒè´§ç‰©ä¿æŠ¤éœ€æ±‚ï¼š</p>
                <ul>
                    <li><strong>éšæ„æ‘†æ”¾ (Free Rotation)</strong>ï¼šç®±å­å¯ä»¥ä»»æ„æ—‹è½¬ï¼ˆ6ç§å§¿æ€ï¼‰ï¼Œå®Œå…¨è¿½æ±‚æœ€å¤§ç©ºé—´åˆ©ç”¨ç‡ã€‚é€‚åˆä¸æ€•æŒ¤å‹çš„æ™®é€šè´§ç‰©</li>
                    <li><strong>ç«‹æ”¾ (Upright Only)</strong>ï¼šåº•å±‚å’Œä¸­é—´å±‚çš„ç®±å­å¿…é¡»"ç«‹ç€æ”¾"ï¼ˆæœ€é•¿è¾¹æœä¸Šï¼‰ï¼Œé˜²æ­¢è´§ç‰©è¢«æŒ¤å‹å—æŸï¼›é¡¶å±‚å¯ä»¥ä»»æ„æ”¾ç½®ä»¥æœ€å¤§åŒ–ç©ºé—´åˆ©ç”¨ç‡ã€‚<strong>é€‚åˆæ˜“ç¢å“ã€æ€•å‹è´§ç‰©</strong></li>
                </ul>
                <div class="help-tip">
                    ğŸ’¡ <strong>æç¤º</strong>ï¼šé€‰æ‹©"ç«‹æ”¾"æ¨¡å¼æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­é¡¶å±‚åŒºåŸŸï¼ˆå®¹å™¨é«˜åº¦80%ä»¥ä¸Šï¼‰ï¼Œé¡¶å±‚ç®±å­å¯ä»»æ„æ—‹è½¬å¡«å……å‰©ä½™ç©ºé—´ã€‚
                </div>
            </div>

            <div class="help-section">
                <h3>ğŸ“¤ å¯¼å‡ºåŠŸèƒ½</h3>
                <p>ç‚¹å‡»ã€Œå¯¼å‡ºç»“æœã€å¯å°†è£…ç®±æ–¹æ¡ˆå¯¼å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«ï¼š</p>
                <ul>
                    <li>é›†è£…ç®±å°ºå¯¸å’Œå„ç±»ç®±å­è£…è½½æ•°é‡</li>
                    <li>ç©ºé—´åˆ©ç”¨ç‡ç»Ÿè®¡</li>
                    <li>æ¯ä¸ªç®±å­çš„è¯¦ç»†æ‘†æ”¾ä½ç½®å’Œå°ºå¯¸</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                <ul>
                    <li>æ‰€æœ‰å°ºå¯¸å•ä½å‡ä¸º<strong>å˜ç±³ï¼ˆcmï¼‰</strong></li>
                    <li>ç®±å­æ—‹è½¬æ–¹å¼å¯é€šè¿‡"æ‘†æ”¾å§¿åŠ¿"é€‰é¡¹æ§åˆ¶ï¼šéšæ„æ‘†æ”¾ï¼ˆ6ç§å§¿æ€ï¼‰æˆ–ç«‹æ”¾ï¼ˆæœ€é•¿è¾¹æœä¸Šï¼‰</li>
                    <li>å®é™…è£…ç®±æ—¶è¯·è€ƒè™‘ç®±å­çš„æ‰¿é‡é™åˆ¶å’Œå †å è¦æ±‚</li>
                    <li>è®¡ç®—ç»“æœä¸ºç†è®ºæœ€ä¼˜æ–¹æ¡ˆï¼Œå®é™…æ“ä½œå¯èƒ½éœ€è¦é€‚å½“è°ƒæ•´</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let scene, camera, renderer, controls;
        let boxes = [];
        let boxCounter = 0;
        let placedBoxes = [];
        let wireframeMode = false;
        let showAxes = true;
        let showContainerBox = true;
        let axesHelper;
        let containerMesh;
        let boxMeshes = []; // å­˜å‚¨æ‰€æœ‰ç®±å­çš„meshå¼•ç”¨
        let boxVisibility = {}; // å­˜å‚¨æ¯ç§ç®±å­çš„æ˜¾ç¤ºçŠ¶æ€

        // Raycaster ç”¨äºé¼ æ ‡æ‚¬æµ®æ£€æµ‹
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredMesh = null;

        // é¢œè‰²æ–¹æ¡ˆ
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52BE80',
            '#EC7063', '#5DADE2', '#48C9B0', '#F5B7B1', '#D7BDE2'
        ];

        // ==================== 3Dåœºæ™¯åˆå§‹åŒ– ====================
        function initScene() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            camera = new THREE.PerspectiveCamera(45, width / height, 1, 10000);
            camera.position.set(2000, 1500, 2000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(1000, 1000, 1000);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // åæ ‡è½´
            axesHelper = new THREE.AxesHelper(500);
            scene.add(axesHelper);

            // ç½‘æ ¼
            const gridHelper = new THREE.GridHelper(3000, 30);
            scene.add(gridHelper);

            // é¼ æ ‡äº‹ä»¶
            renderer.domElement.addEventListener('mousemove', onMouseMove, false);
            renderer.domElement.addEventListener('mouseleave', onMouseLeave, false);

            animate();
            window.addEventListener('resize', onWindowResize, false);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // æ£€æµ‹é¼ æ ‡æ‚¬æµ®
            checkHover();
            
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // ==================== é¼ æ ‡æ‚¬æµ®æ£€æµ‹ ====================
        function onMouseMove(event) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;
            
            // æ›´æ–°tooltipä½ç½®
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
            tooltip.style.top = (event.clientY - rect.top + 15) + 'px';
        }

        function onMouseLeave() {
            hideTooltip();
            if (hoveredMesh) {
                hoveredMesh.material.emissive.setHex(0x000000);
                hoveredMesh = null;
            }
        }

        function checkHover() {
            if (boxMeshes.length === 0) return;

            raycaster.setFromCamera(mouse, camera);
            const visibleMeshes = boxMeshes.filter(m => m.visible);
            const intersects = raycaster.intersectObjects(visibleMeshes);

            if (intersects.length > 0) {
                const mesh = intersects[0].object;
                
                if (hoveredMesh !== mesh) {
                    // æ¢å¤ä¹‹å‰æ‚¬æµ®çš„mesh
                    if (hoveredMesh) {
                        hoveredMesh.material.emissive.setHex(0x000000);
                    }
                    
                    hoveredMesh = mesh;
                    mesh.material.emissive.setHex(0x333333);
                    showTooltip(mesh.userData);
                }
            } else {
                if (hoveredMesh) {
                    hoveredMesh.material.emissive.setHex(0x000000);
                    hoveredMesh = null;
                    hideTooltip();
                }
            }
        }

        function showTooltip(boxData) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="tooltip-title" style="color: ${boxData.color}">ğŸ“¦ ${boxData.name}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">å°ºå¯¸ï¼š</span>
                    <span class="tooltip-value">${boxData.length} Ã— ${boxData.width} Ã— ${boxData.height} cm</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">ä½ç½®ï¼š</span>
                    <span class="tooltip-value">(${boxData.x}, ${boxData.y}, ${boxData.z})</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">ä½“ç§¯ï¼š</span>
                    <span class="tooltip-value">${((boxData.length * boxData.width * boxData.height) / 1000000).toFixed(4)} mÂ³</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">åºå·ï¼š</span>
                    <span class="tooltip-value">#${boxData.index + 1}</span>
                </div>
            `;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // ==================== è¾“å…¥ç®¡ç† ====================
        // ç­–ç•¥æè¿°æ˜ å°„
        var strategyDescriptions = {
            'bottom-left': 'ğŸ“¦ ä¼˜å…ˆå¡«æ»¡åº•å±‚ç©ºé—´ï¼Œä»åº•éƒ¨å¼€å§‹å‘ä¸Šå †å ï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚é€‚åˆé‡å¿ƒè¦æ±‚é«˜çš„åœºæ™¯ã€‚',
            'layer': 'ğŸ“¦ ä¸¥æ ¼æŒ‰å±‚å¡«å……ï¼ŒåŒå±‚ç®±å­é«˜åº¦æ¥è¿‘ï¼Œæ•´é½åº¦æœ€é«˜ã€‚é€‚åˆéœ€è¦åˆ†å±‚ç®¡ç†çš„è´§ç‰©ã€‚',
            'back-front': 'ğŸ“¦ ä»é›†è£…ç®±åéƒ¨ï¼ˆæ·±å¤„ï¼‰å¾€å‰é—¨æ–¹å‘å¡«å……ã€‚é€‚åˆéœ€è¦æŒ‰é¡ºåºå¸è´§çš„åœºæ™¯ï¼ˆå…ˆè£…åå¸ï¼‰ã€‚',
            'wall': 'ğŸ“¦ æ²¿é•¿åº¦æ–¹å‘é€é¢æ„å»º"å¢™"ï¼Œå…ˆå¡«æ»¡ä¸€é¢å¢™å†ç§»åŠ¨åˆ°ä¸‹ä¸€é¢ã€‚é€‚åˆåˆ†åŒºç®¡ç†ã€‚',
            'ffd': 'ğŸ“¦ æŒ‰ä½“ç§¯ä»å¤§åˆ°å°æ’åºï¼Œä¼˜å…ˆæ”¾ç½®å¤§ä»¶ç‰©å“ï¼Œç©ºé—´åˆ©ç”¨ç‡é€šå¸¸æœ€é«˜ã€‚æ¨èé»˜è®¤ä½¿ç”¨ã€‚',
            'manual': 'ğŸ“¦ å®Œå…¨æŒ‰ç…§æ‚¨æ·»åŠ /æ‹–æ‹½çš„é¡ºåºæ”¾ç½®ï¼Œæ»¡è¶³ç‰¹å®šä¸šåŠ¡éœ€æ±‚ï¼ˆå¦‚ä¼˜å…ˆçº§ã€ç´§æ€¥ç¨‹åº¦ç­‰ï¼‰ã€‚'
        };

        // æ‘†æ”¾å§¿åŠ¿æè¿°æ˜ å°„
        var orientationDescriptions = {
            'free': 'ğŸ“¦ ç®±å­å¯ä»¥ä»»æ„æ—‹è½¬ï¼ˆ6ç§å§¿æ€ï¼‰ï¼Œè¿½æ±‚æœ€å¤§ç©ºé—´åˆ©ç”¨ç‡ã€‚é€‚åˆä¸æ€•æŒ¤å‹çš„æ™®é€šè´§ç‰©ã€‚',
            'upright': 'ğŸ“¦ åº•å±‚/ä¸­é—´å±‚ç®±å­"ç«‹ç€æ”¾"ï¼ˆæœ€é•¿è¾¹æœä¸Šï¼‰ï¼Œé˜²æ­¢æŒ¤å‹å—æŸï¼›é¡¶å±‚å¯ä»»æ„æ”¾ä»¥æœ€å¤§åŒ–åˆ©ç”¨ç‡ã€‚é€‚åˆæ˜“ç¢å“ã€æ€•å‹è´§ç‰©ã€‚'
        };

        function updateStrategyDesc() {
            var strategy = document.getElementById('packing-strategy').value;
            document.getElementById('strategy-desc').textContent = strategyDescriptions[strategy];
        }

        function updateOrientationDesc() {
            var orientation = document.getElementById('orientation-mode').value;
            document.getElementById('orientation-desc').textContent = orientationDescriptions[orientation];
        }

        // ==================== æ‹–æ‹½æ’åºåŠŸèƒ½ ====================
        var draggedItem = null;

        function initDragAndDrop(element) {
            element.setAttribute('draggable', 'true');
            
            element.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            });
            
            element.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                // ç§»é™¤æ‰€æœ‰ drag-over æ ·å¼
                document.querySelectorAll('.box-item').forEach(function(item) {
                    item.classList.remove('drag-over');
                });
                draggedItem = null;
            });
            
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (this !== draggedItem) {
                    this.classList.add('drag-over');
                }
            });
            
            element.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            
            element.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (this !== draggedItem && draggedItem) {
                    var container = document.getElementById('boxes-container');
                    var allItems = Array.from(container.querySelectorAll('.box-item'));
                    var draggedIdx = allItems.indexOf(draggedItem);
                    var targetIdx = allItems.indexOf(this);
                    
                    if (draggedIdx < targetIdx) {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this);
                    }
                    
                    // æ›´æ–°ç®±å­ç¼–å·æ˜¾ç¤º
                    updateBoxNumbers();
                }
            });
        }

        function updateBoxNumbers() {
            var boxItems = document.querySelectorAll('.box-item');
            boxItems.forEach(function(item, index) {
                var header = item.querySelector('.box-item-header strong');
                if (header) {
                    var id = item.id.split('-')[1];
                    header.textContent = 'ç®±å­ ' + id + ' (é¡ºåº: ' + (index + 1) + ')';
                }
            });
        }

        function addBox() {
            boxCounter++;
            const color = colors[(boxCounter - 1) % colors.length];
            const boxHtml = `
                <div class="box-item" id="box-${boxCounter}">
                    <button class="btn-remove" onclick="removeBox(${boxCounter})">Ã—</button>
                    <div class="box-item-header">
                        <span class="drag-handle">â‹®â‹®</span>
                        <div class="color-indicator" style="background-color: ${color}"></div>
                        <strong>ç®±å­ ${boxCounter}</strong>
                    </div>
                    <div class="input-group">
                        <label>å°ºå¯¸ (cm)</label>
                        <div class="input-row">
                            <input type="number" placeholder="é•¿" value="${50 + boxCounter * 10}" min="1" data-box="${boxCounter}" data-field="length">
                            <input type="number" placeholder="å®½" value="${40 + boxCounter * 5}" min="1" data-box="${boxCounter}" data-field="width">
                            <input type="number" placeholder="é«˜" value="${30 + boxCounter * 5}" min="1" data-box="${boxCounter}" data-field="height">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>æ•°é‡</label>
                        <input type="number" placeholder="æ•°é‡" value="${10 + boxCounter * 5}" min="1" data-box="${boxCounter}" data-field="quantity" style="width: 100%">
                    </div>
                </div>
            `;
            document.getElementById('boxes-container').insertAdjacentHTML('beforeend', boxHtml);
            
            // ä¸ºæ–°æ·»åŠ çš„ç®±å­åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            var newBox = document.getElementById('box-' + boxCounter);
            initDragAndDrop(newBox);
            
            // æ›´æ–°é¡ºåºæ˜¾ç¤º
            updateBoxNumbers();
        }

        function removeBox(id) {
            document.getElementById(`box-${id}`).remove();
            updateBoxNumbers();
        }

        function getInputData() {
            const container = {
                length: parseFloat(document.getElementById('container-length').value),
                width: parseFloat(document.getElementById('container-width').value),
                height: parseFloat(document.getElementById('container-height').value)
            };

            boxes = [];
            const boxElements = document.querySelectorAll('.box-item');
            boxElements.forEach((element, index) => {
                const id = element.id.split('-')[1];
                const length = parseFloat(element.querySelector(`[data-box="${id}"][data-field="length"]`).value);
                const width = parseFloat(element.querySelector(`[data-box="${id}"][data-field="width"]`).value);
                const height = parseFloat(element.querySelector(`[data-box="${id}"][data-field="height"]`).value);
                const quantity = parseInt(element.querySelector(`[data-box="${id}"][data-field="quantity"]`).value);
                
                boxes.push({
                    id: parseInt(id),
                    length, width, height, quantity,
                    color: colors[index % colors.length],
                    name: `ç®±å­ ${id}`
                });
            });

            return { container, boxes };
        }

        // ==================== Web Worker è£…ç®±ç®—æ³• ====================
        // åˆ›å»º Web Worker çš„å†…è”ä»£ç ï¼ˆä½¿ç”¨æ•°ç»„æ‹¼æ¥é¿å…ç¼–ç é—®é¢˜ï¼‰
        var workerCodeLines = [
            'function isPointInsideBox(point, box) {',
            '    return point.x >= box.x && point.x < box.x + box.length &&',
            '           point.y >= box.y && point.y < box.y + box.height &&',
            '           point.z >= box.z && point.z < box.z + box.width;',
            '}',
            '',
            'function checkCollisionFast(newBox, placedBoxes) {',
            '    var ax1 = newBox.x, ax2 = newBox.x + newBox.length;',
            '    var ay1 = newBox.y, ay2 = newBox.y + newBox.height;',
            '    var az1 = newBox.z, az2 = newBox.z + newBox.width;',
            '    for (var i = placedBoxes.length - 1; i >= 0; i--) {',
            '        var b = placedBoxes[i];',
            '        if (ax1 < b.x + b.length && ax2 > b.x &&',
            '            ay1 < b.y + b.height && ay2 > b.y &&',
            '            az1 < b.z + b.width && az2 > b.z) {',
            '            return true;',
            '        }',
            '    }',
            '    return false;',
            '}',
            '',
            '// æ ¹æ®æ‘†æ”¾å§¿åŠ¿è¿‡æ»¤æœ‰æ•ˆçš„æ—‹è½¬æ–¹å¼',
            '// orientation: "free" éšæ„æ‘†æ”¾, "upright" ç«‹æ”¾ï¼ˆæœ€é•¿è¾¹æœä¸Šï¼‰',
            'function getValidRotations(box, orientation, pointY, containerHeight) {',
            '    var l = box.length, w = box.width, h = box.height;',
            '    // æ‰€æœ‰6ç§æ—‹è½¬æ–¹å¼ï¼š[é•¿åº¦, å®½åº¦, é«˜åº¦]',
            '    var allDims = [',
            '        [l, w, h], [l, h, w], [w, l, h], [w, h, l], [h, l, w], [h, w, l]',
            '    ];',
            '    ',
            '    // å»é‡',
            '    var rotationsSet = {};',
            '    var rotations = [];',
            '    for (var di = 0; di < allDims.length; di++) {',
            '        var d = allDims[di];',
            '        var key = d[0] + "-" + d[1] + "-" + d[2];',
            '        if (!rotationsSet[key]) {',
            '            rotationsSet[key] = true;',
            '            rotations.push({ l: d[0], w: d[1], h: d[2] });',
            '        }',
            '    }',
            '    ',
            '    // å¦‚æœæ˜¯éšæ„æ‘†æ”¾ï¼Œè¿”å›æ‰€æœ‰æ—‹è½¬',
            '    if (orientation === "free") {',
            '        return rotations;',
            '    }',
            '    ',
            '    // ç«‹æ”¾æ¨¡å¼ï¼šåº•å±‚å’Œä¸­é—´å±‚åªä¿ç•™æœ€é•¿è¾¹æœä¸Šçš„æ—‹è½¬',
            '    if (orientation === "upright") {',
            '        var maxDim = Math.max(l, w, h);',
            '        // åˆ¤æ–­æ˜¯å¦æ¥è¿‘é¡¶å±‚ï¼ˆYä½ç½® + æœ€é•¿è¾¹ > å®¹å™¨é«˜åº¦çš„80%ï¼‰',
            '        var isNearTop = (pointY + maxDim) > containerHeight * 0.8;',
            '        ',
            '        if (isNearTop) {',
            '            // é¡¶å±‚åŒºåŸŸï¼šå¯ä»¥ä»»æ„æ”¾ç½®ä»¥æœ€å¤§åŒ–ç©ºé—´åˆ©ç”¨ç‡',
            '            return rotations;',
            '        } else {',
            '            // éé¡¶å±‚ï¼šåªä¿ç•™æœ€é•¿è¾¹ä½œä¸ºé«˜åº¦ï¼ˆæœä¸Šï¼‰çš„æ—‹è½¬',
            '            var uprightRotations = [];',
            '            for (var ri = 0; ri < rotations.length; ri++) {',
            '                var rot = rotations[ri];',
            '                // é«˜åº¦å¿…é¡»æ˜¯æœ€é•¿è¾¹ï¼ˆç«‹æ”¾ï¼‰',
            '                if (rot.h === maxDim) {',
            '                    uprightRotations.push(rot);',
            '                }',
            '            }',
            '            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æœ‰æ•ˆæ—‹è½¬ï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œè¿”å›åŸå§‹æ—‹è½¬',
            '            return uprightRotations.length > 0 ? uprightRotations : rotations;',
            '        }',
            '    }',
            '    ',
            '    return rotations;',
            '}',
            '',
            '// æ ¹æ®ç­–ç•¥è®¡ç®—è¯„åˆ†ï¼ˆåˆ†æ•°è¶Šä½è¶Šä¼˜å…ˆï¼‰',
            '// å…³é”®æ”¹è¿›ï¼šä½¿ç”¨æ›´ç²¾ç»†çš„åŒºåŸŸåˆ’åˆ†ï¼Œç¡®ä¿å¡«æ»¡ä¸€ä¸ªåŒºåŸŸå†ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª',
            'function getScoreByStrategy(point, rot, container, strategy, placedBoxes) {',
            '    var x = point.x, y = point.y, z = point.z;',
            '    ',
            '    // è®¡ç®—å½“å‰å·²æ”¾ç½®ç®±å­çš„è¾¹ç•Œï¼Œç”¨äºåŒºåŸŸåˆ’åˆ†',
            '    var maxX = 0, maxY = 0, maxZ = 0;',
            '    for (var i = 0; i < placedBoxes.length; i++) {',
            '        var pb = placedBoxes[i];',
            '        if (pb.x + pb.length > maxX) maxX = pb.x + pb.length;',
            '        if (pb.y + pb.height > maxY) maxY = pb.y + pb.height;',
            '        if (pb.z + pb.width > maxZ) maxZ = pb.z + pb.width;',
            '    }',
            '    ',
            '    switch (strategy) {',
            '        case "bottom-left":',
            '            // åº•å±‚ä¼˜å…ˆï¼šYè½´æœ€ä½ -> Xè½´æœ€å° -> Zè½´æœ€å°',
            '            // ä¼˜å…ˆå¡«æ»¡åº•å±‚ï¼Œç„¶åå‘ä¸Šå †å ',
            '            return y * 1000000 + x * 1000 + z;',
            '        ',
            '        case "layer":',
            '            // åˆ†å±‚é“ºæ»¡ï¼šä¸¥æ ¼æŒ‰å±‚å¡«å……',
            '            // ä¼˜å…ˆåœ¨å½“å‰å±‚ï¼ˆYèŒƒå›´å†…ï¼‰å¡«æ»¡ï¼Œå±‚æ»¡åæ‰å¼€æ–°å±‚',
            '            var layerHeight = rot ? rot.h : 50;',
            '            var currentLayer = Math.floor(y / Math.max(layerHeight, 1));',
            '            // åŒå±‚å†…ä¼˜å…ˆXæœ€å°ï¼Œç„¶åZæœ€å°',
            '            return currentLayer * 100000000 + x * 10000 + z * 10 + y;',
            '        ',
            '        case "back-front":',
            '            // åå‘å †å ï¼šä»åå¾€å‰å¡«å……ï¼ˆZè½´ä»å¤§åˆ°å°ï¼‰',
            '            // æ ¸å¿ƒï¼šä¼˜å…ˆå¡«æ»¡åéƒ¨åŒºåŸŸï¼Œé€æ¸å‘å‰æ¨è¿›',
            '            // 1. é¦–å…ˆæŒ‰Zè½´åˆ’åˆ†åŒºåŸŸï¼ˆä»ååˆ°å‰ï¼‰',
            '            // 2. åœ¨åŒä¸€ZåŒºåŸŸå†…ï¼Œä¼˜å…ˆåº•å±‚(Yå°)ï¼Œå†é å·¦(Xå°)',
            '            var zRegionSize = container.width / 4; // å°†æ·±åº¦åˆ†æˆ4ä¸ªåŒºåŸŸ',
            '            var zRegion = Math.floor((container.width - z) / Math.max(zRegionSize, 1));',
            '            // åŒåŒºåŸŸå†…ä¼˜å…ˆåº•å±‚ã€é å·¦',
            '            return zRegion * 100000000 + y * 10000 + x * 10 + (container.width - z);',
            '        ',
            '        case "wall":',
            '            // å¢™æ„å»ºæ³•ï¼šæ²¿Xè½´é€é¢æ„å»º"å¢™"',
            '            // æ ¸å¿ƒï¼šå…ˆå¡«æ»¡ä¸€é¢å¢™ï¼ˆY-Zå¹³é¢ï¼‰ï¼Œå†ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªXä½ç½®',
            '            // 1. é¦–å…ˆæŒ‰Xè½´åˆ’åˆ†åŒºåŸŸï¼ˆä»å·¦åˆ°å³æ„å»ºå¢™ï¼‰',
            '            // 2. åœ¨åŒä¸€é¢å¢™å†…ï¼Œä¼˜å…ˆåº•å±‚(Yå°)ï¼Œå†é å(Zå°)',
            '            var wallThickness = container.length / 6; // å°†é•¿åº¦åˆ†æˆ6é¢å¢™',
            '            var wallRegion = Math.floor(x / Math.max(wallThickness, 1));',
            '            // åŒä¸€é¢å¢™å†…ä¼˜å…ˆåº•å±‚ã€é å',
            '            return wallRegion * 100000000 + y * 10000 + z * 10 + x;',
            '        ',
            '        case "ffd":',
            '        case "manual":',
            '        default:',
            '            // ä½“ç§¯ä¼˜å…ˆ/ç”¨æˆ·é¡ºåºï¼šä½¿ç”¨åº•å±‚ä¼˜å…ˆè¯„åˆ†',
            '            return y * 1000000 + x * 1000 + z;',
            '    }',
            '}',
            '',
            '// æ ¹æ®ç­–ç•¥å¯¹ç®±å­æ’åº',
            'function sortBoxesByStrategy(allBoxes, strategy) {',
            '    switch (strategy) {',
            '        case "ffd":',
            '            // ä½“ç§¯ä¼˜å…ˆï¼šæŒ‰ä½“ç§¯ä»å¤§åˆ°å°',
            '            allBoxes.sort(function(a, b) {',
            '                if (b.volume !== a.volume) return b.volume - a.volume;',
            '                return b.maxFace - a.maxFace;',
            '            });',
            '            break;',
            '        case "layer":',
            '            // åˆ†å±‚ï¼šæŒ‰é«˜åº¦åˆ†ç»„ï¼ŒåŒç»„å†…æŒ‰åº•é¢ç§¯ä»å¤§åˆ°å°',
            '            // è¿™æ ·ç›¸åŒé«˜åº¦çš„ç®±å­ä¼šåœ¨åŒä¸€å±‚',
            '            allBoxes.sort(function(a, b) {',
            '                var minHA = Math.min(a.length, a.width, a.height);',
            '                var minHB = Math.min(b.length, b.width, b.height);',
            '                // å…ˆæŒ‰æœ€å°è¾¹ï¼ˆä½œä¸ºé«˜åº¦ï¼‰åˆ†ç»„',
            '                if (minHA !== minHB) return minHA - minHB;',
            '                // åŒé«˜åº¦æŒ‰åº•é¢ç§¯ä»å¤§åˆ°å°',
            '                return b.volume - a.volume;',
            '            });',
            '            break;',
            '        case "wall":',
            '            // å¢™æ„å»ºï¼šæŒ‰æœ€å¤§é¢ï¼ˆå¢™é¢ï¼‰ä»å¤§åˆ°å°',
            '            allBoxes.sort(function(a, b) {',
            '                if (b.maxFace !== a.maxFace) return b.maxFace - a.maxFace;',
            '                return b.volume - a.volume;',
            '            });',
            '            break;',
            '        case "back-front":',
            '            // åå‘å †å ï¼šæŒ‰ä½“ç§¯ä»å¤§åˆ°å°',
            '            allBoxes.sort(function(a, b) {',
            '                if (b.volume !== a.volume) return b.volume - a.volume;',
            '                return b.maxFace - a.maxFace;',
            '            });',
            '            break;',
            '        case "manual":',
            '            // ç”¨æˆ·é¡ºåºï¼šä¿æŒåŸåºï¼ŒæŒ‰ orderIndex æ’åº',
            '            allBoxes.sort(function(a, b) {',
            '                return a.orderIndex - b.orderIndex;',
            '            });',
            '            break;',
            '        case "bottom-left":',
            '        default:',
            '            // åº•å±‚ä¼˜å…ˆï¼šæŒ‰ä½“ç§¯ä»å¤§åˆ°å°',
            '            allBoxes.sort(function(a, b) {',
            '                if (b.volume !== a.volume) return b.volume - a.volume;',
            '                return b.maxFace - a.maxFace;',
            '            });',
            '            break;',
            '    }',
            '}',
            '',
            '// æ ¹æ®ç­–ç•¥å¯¹æç‚¹æ’åº',
            'function sortExtremePointsByStrategy(extremePoints, container, strategy, placedBoxes) {',
            '    extremePoints.sort(function(a, b) {',
            '        var scoreA = getScoreByStrategy(a, null, container, strategy, placedBoxes);',
            '        var scoreB = getScoreByStrategy(b, null, container, strategy, placedBoxes);',
            '        return scoreA - scoreB;',
            '    });',
            '}',
            '',
            'function packBoxes(container, boxes, strategy, orientation) {',
            '    var placedBoxes = [];',
            '    var extremePoints = [{ x: 0, y: 0, z: 0 }];',
            '    var MAX_EXTREME_POINTS = 800;',
            '    var allBoxes = [];',
            '    var orderIndex = 0;',
            '    boxes.forEach(function(box) {',
            '        for (var i = 0; i < box.quantity; i++) {',
            '            var faces = [box.length * box.width, box.length * box.height, box.width * box.height];',
            '            allBoxes.push({',
            '                id: box.id, name: box.name, color: box.color,',
            '                length: box.length, width: box.width, height: box.height,',
            '                quantity: box.quantity,',
            '                volume: box.length * box.width * box.height,',
            '                maxFace: Math.max.apply(null, faces),',
            '                orderIndex: orderIndex++',
            '            });',
            '        }',
            '    });',
            '',
            '    // æ ¹æ®ç­–ç•¥æ’åº',
            '    sortBoxesByStrategy(allBoxes, strategy);',
            '',
            '    var totalBoxes = allBoxes.length;',
            '    var lastProgress = 0;',
            '    ',
            '    for (var boxIdx = 0; boxIdx < allBoxes.length; boxIdx++) {',
            '        var box = allBoxes[boxIdx];',
            '        var progress = Math.floor((boxIdx / totalBoxes) * 100);',
            '        if (progress >= lastProgress + 10) {',
            '            lastProgress = progress;',
            '            self.postMessage({ type: "progress", progress: progress, placed: placedBoxes.length });',
            '        }',
            '        var bestPlacement = null;',
            '        var bestScore = Infinity;',
            '        ',
            '        // æ ¹æ®ç­–ç•¥æ’åºæç‚¹',
            '        sortExtremePointsByStrategy(extremePoints, container, strategy, placedBoxes);',
            '        ',
            '        var pointsToCheck = extremePoints.slice(0, MAX_EXTREME_POINTS);',
            '        for (var pi = 0; pi < pointsToCheck.length; pi++) {',
            '            var point = pointsToCheck[pi];',
            '            ',
            '            // æ ¹æ®æ‘†æ”¾å§¿åŠ¿å’Œå½“å‰ä½ç½®è·å–æœ‰æ•ˆæ—‹è½¬',
            '            var rotations = getValidRotations(box, orientation, point.y, container.height);',
            '            ',
            '            for (var ri = 0; ri < rotations.length; ri++) {',
            '                var rot = rotations[ri];',
            '                if (point.x + rot.l > container.length ||',
            '                    point.y + rot.h > container.height ||',
            '                    point.z + rot.w > container.width) {',
            '                    continue;',
            '                }',
            '                var newBox = { x: point.x, y: point.y, z: point.z, length: rot.l, width: rot.w, height: rot.h };',
            '                if (!checkCollisionFast(newBox, placedBoxes)) {',
            '                    var score = getScoreByStrategy(point, rot, container, strategy, placedBoxes);',
            '                    if (score < bestScore) {',
            '                        bestScore = score;',
            '                        bestPlacement = {',
            '                            id: box.id, name: box.name, color: box.color,',
            '                            x: point.x, y: point.y, z: point.z,',
            '                            length: rot.l, width: rot.w, height: rot.h',
            '                        };',
            '                    }',
            '                }',
            '            }',
            '        }',
            '        if (bestPlacement) {',
            '            placedBoxes.push(bestPlacement);',
            '            var newPoints = [',
            '                { x: bestPlacement.x + bestPlacement.length, y: bestPlacement.y, z: bestPlacement.z },',
            '                { x: bestPlacement.x, y: bestPlacement.y + bestPlacement.height, z: bestPlacement.z },',
            '                { x: bestPlacement.x, y: bestPlacement.y, z: bestPlacement.z + bestPlacement.width }',
            '            ];',
            '            for (var ni = 0; ni < newPoints.length; ni++) {',
            '                var np = newPoints[ni];',
            '                var exists = false;',
            '                for (var ei = 0; ei < extremePoints.length; ei++) {',
            '                    var ep = extremePoints[ei];',
            '                    if (ep.x === np.x && ep.y === np.y && ep.z === np.z) {',
            '                        exists = true;',
            '                        break;',
            '                    }',
            '                }',
            '                if (!exists) extremePoints.push(np);',
            '            }',
            '            extremePoints = extremePoints.filter(function(ep) {',
            '                return !isPointInsideBox(ep, bestPlacement);',
            '            });',
            '            if (extremePoints.length > MAX_EXTREME_POINTS * 2) {',
            '                sortExtremePointsByStrategy(extremePoints, container, strategy, placedBoxes);',
            '                extremePoints = extremePoints.slice(0, MAX_EXTREME_POINTS);',
            '            }',
            '        }',
            '    }',
            '    return placedBoxes;',
            '}',
            '',
            'self.onmessage = function(e) {',
            '    var data = e.data;',
            '    var startTime = performance.now();',
            '    var result = packBoxes(data.container, data.boxes, data.strategy, data.orientation);',
            '    var duration = performance.now() - startTime;',
            '    self.postMessage({ type: "result", data: result, duration: duration });',
            '};'
        ];
        var workerCode = workerCodeLines.join('\n');

        // åˆ›å»º Worker Blob URL
        var workerBlob = new Blob([workerCode], { type: 'application/javascript' });
        var workerUrl = URL.createObjectURL(workerBlob);
        var packingWorker = null;

        // åˆ›å»º/é‡ç”¨ Worker
        function getWorker() {
            if (!packingWorker) {
                packingWorker = new Worker(workerUrl);
            }
            return packingWorker;
        }

        // ä½¿ç”¨ Worker è¿›è¡Œè£…ç®±è®¡ç®—
        function packBoxesAsync(container, boxes, strategy, orientation) {
            return new Promise(function(resolve, reject) {
                var worker = getWorker();
                
                worker.onmessage = function(e) {
                    if (e.data.type === 'progress') {
                        var loadingEl = document.getElementById('loading');
                        loadingEl.innerHTML = 'æ­£åœ¨è®¡ç®—æœ€ä¼˜æ–¹æ¡ˆ...<br><span style="font-size: 14px; opacity: 0.8;">è¿›åº¦: ' + e.data.progress + '% (å·²æ”¾ç½® ' + e.data.placed + ' ä¸ª)</span>';
                    } else if (e.data.type === 'result') {
                        resolve({ result: e.data.data, duration: e.data.duration });
                    }
                };
                
                worker.onerror = function(error) {
                    reject(error);
                };
                
                worker.postMessage({ container: container, boxes: boxes, strategy: strategy, orientation: orientation });
            });
        }

        // å¿«é€Ÿç¢°æ’æ£€æµ‹ï¼ˆåŒæ­¥ç‰ˆæœ¬ä½¿ç”¨ï¼‰
        function checkCollisionFast(newBox, placedBoxes) {
            var ax1 = newBox.x, ax2 = newBox.x + newBox.length;
            var ay1 = newBox.y, ay2 = newBox.y + newBox.height;
            var az1 = newBox.z, az2 = newBox.z + newBox.width;
            for (var i = placedBoxes.length - 1; i >= 0; i--) {
                var b = placedBoxes[i];
                if (ax1 < b.x + b.length && ax2 > b.x && ay1 < b.y + b.height && ay2 > b.y && az1 < b.z + b.width && az2 > b.z) {
                    return true;
                }
            }
            return false;
        }

        // ==================== 3Då¯è§†åŒ– ====================
        function visualizeResults(container, placedBoxes) {
            // æ¸…é™¤æ—§å¯¹è±¡
            while(scene.children.length > 0) { 
                scene.remove(scene.children[0]); 
            }
            boxMeshes = [];

            // é‡æ–°æ·»åŠ å…‰æºå’Œè¾…åŠ©å¯¹è±¡
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(1000, 1000, 1000);
            scene.add(directionalLight);

            if (showAxes) {
                axesHelper = new THREE.AxesHelper(500);
                scene.add(axesHelper);
            }

            const gridHelper = new THREE.GridHelper(3000, 30);
            scene.add(gridHelper);

            // ç»˜åˆ¶é›†è£…ç®±è¾¹æ¡†
            const containerGeometry = new THREE.BoxGeometry(container.length, container.height, container.width);
            const containerEdges = new THREE.EdgesGeometry(containerGeometry);
            containerMesh = new THREE.LineSegments(
                containerEdges,
                new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 })
            );
            containerMesh.position.set(container.length / 2, container.height / 2, container.width / 2);
            containerMesh.visible = showContainerBox;
            scene.add(containerMesh);

            // ç»˜åˆ¶å·²æ”¾ç½®çš„ç®±å­
            placedBoxes.forEach((box, index) => {
                const geometry = new THREE.BoxGeometry(box.length, box.height, box.width);
                const material = new THREE.MeshPhongMaterial({
                    color: box.color,
                    transparent: true,
                    opacity: 0.85,
                    wireframe: wireframeMode
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(
                    box.x + box.length / 2,
                    box.y + box.height / 2,
                    box.z + box.width / 2
                );

                // å­˜å‚¨ç®±å­ä¿¡æ¯ç”¨äºæ‚¬æµ®æç¤º
                mesh.userData = {
                    ...box,
                    index: index
                };

                // æ·»åŠ è¾¹æ¡†
                const edges = new THREE.EdgesGeometry(geometry);
                const line = new THREE.LineSegments(
                    edges,
                    new THREE.LineBasicMaterial({ color: 0x000000 })
                );
                line.position.copy(mesh.position);
                
                // å°†è¾¹æ¡†ä½œä¸ºmeshçš„å­å¯¹è±¡ï¼Œæ–¹ä¾¿ä¸€èµ·éšè—
                mesh.add(line);
                line.position.set(0, 0, 0);
                
                scene.add(mesh);
                boxMeshes.push(mesh);
            });

            // åˆå§‹åŒ–æ‰€æœ‰ç®±å­ç±»å‹ä¸ºå¯è§
            boxes.forEach(box => {
                boxVisibility[box.id] = true;
            });

            // è°ƒæ•´ç›¸æœºä½ç½®
            const maxDim = Math.max(container.length, container.width, container.height);
            camera.position.set(maxDim * 1.5, maxDim * 1.2, maxDim * 1.5);
            controls.target.set(container.length / 2, container.height / 2, container.width / 2);
            controls.update();
        }

        // ==================== ç»“æœå±•ç¤º ====================
        function displayResults(container, boxes, placedBoxes) {
            const containerVolume = (container.length * container.width * container.height) / 1000000;
            let usedVolume = 0;
            const boxCounts = {};

            placedBoxes.forEach(box => {
                usedVolume += (box.length * box.width * box.height) / 1000000;
                boxCounts[box.id] = (boxCounts[box.id] || 0) + 1;
            });

            const utilizationRate = (usedVolume / containerVolume * 100).toFixed(2);

            // æ›´æ–°ç­–ç•¥æ˜¾ç¤º
            document.getElementById('algorithm-badge').textContent = strategyNames[currentStrategy];

            document.getElementById('utilization-rate').textContent = utilizationRate + '%';
            document.getElementById('utilization-fill').style.width = utilizationRate + '%';
            document.getElementById('utilization-fill').textContent = utilizationRate + '%';
            document.getElementById('container-volume').textContent = containerVolume.toFixed(2) + ' mÂ³';
            document.getElementById('used-volume').textContent = usedVolume.toFixed(2) + ' mÂ³';
            document.getElementById('total-boxes').textContent = placedBoxes.length;

            // æ˜¾ç¤ºå„ç±»ç®±å­è¯¦æƒ…
            let detailsHtml = '';
            boxes.forEach(box => {
                const count = boxCounts[box.id] || 0;
                detailsHtml += `
                    <div class="result-item">
                        <span class="result-label">
                            <span style="display: inline-block; width: 15px; height: 15px; background: ${box.color}; border-radius: 3px; margin-right: 8px; vertical-align: middle;"></span>
                            ${box.name} (${box.length}Ã—${box.width}Ã—${box.height}cm)
                        </span>
                        <span class="result-value">${count} / ${box.quantity}</span>
                    </div>
                `;
            });
            document.getElementById('box-details').innerHTML = detailsHtml;

            // æ˜¾ç¤ºå¯äº¤äº’çš„å›¾ä¾‹
            let legendHtml = '';
            boxes.forEach(box => {
                legendHtml += `
                    <div class="legend-item active" data-box-id="${box.id}" onclick="toggleBoxVisibility(${box.id})">
                        <div class="legend-color" style="background-color: ${box.color}"></div>
                        <div class="legend-text">${box.name}<br>${box.length}Ã—${box.width}Ã—${box.height}cm</div>
                    </div>
                `;
            });
            document.getElementById('legend').innerHTML = legendHtml;

            document.getElementById('legend-panel').style.display = 'block';
            document.getElementById('results').style.display = 'block';
        }

        // ==================== å›¾ä¾‹äº¤äº’ - æ˜¾ç¤º/éšè—ç®±å­ ====================
        function toggleBoxVisibility(boxId) {
            boxVisibility[boxId] = !boxVisibility[boxId];
            const isVisible = boxVisibility[boxId];

            // æ›´æ–°å›¾ä¾‹æ ·å¼
            const legendItem = document.querySelector(`.legend-item[data-box-id="${boxId}"]`);
            if (isVisible) {
                legendItem.classList.remove('hidden');
                legendItem.classList.add('active');
            } else {
                legendItem.classList.add('hidden');
                legendItem.classList.remove('active');
            }

            // æ›´æ–°3Dåœºæ™¯ä¸­å¯¹åº”ç®±å­çš„å¯è§æ€§
            boxMeshes.forEach(mesh => {
                if (mesh.userData.id === boxId) {
                    mesh.visible = isVisible;
                }
            });
        }

        // ==================== è®¡ç®—å…¥å£ ====================
        var currentStrategy = 'ffd'; // å½“å‰ä½¿ç”¨çš„ç­–ç•¥
        var strategyNames = {
            'bottom-left': 'åº•å±‚ä¼˜å…ˆ',
            'layer': 'åˆ†å±‚é“ºæ»¡',
            'back-front': 'åå‘å †å ',
            'wall': 'å¢™æ„å»ºæ³•',
            'ffd': 'ä½“ç§¯ä¼˜å…ˆ (FFD)',
            'manual': 'ç”¨æˆ·é¡ºåº'
        };

        async function calculate() {
            var data = getInputData();
            
            if (data.boxes.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ç§ç®±å­ï¼');
                return;
            }

            // è·å–å½“å‰é€‰æ‹©çš„ç­–ç•¥å’Œå§¿åŠ¿
            currentStrategy = document.getElementById('packing-strategy').value;
            var currentOrientation = document.getElementById('orientation-mode').value;

            // å§¿åŠ¿åç§°æ˜ å°„
            var orientationNames = {
                'free': 'éšæ„æ‘†æ”¾',
                'upright': 'ç«‹æ”¾'
            };

            // è®¡ç®—æ€»ç®±å­æ•°ç”¨äºæ˜¾ç¤º
            var totalBoxCount = data.boxes.reduce(function(sum, b) { return sum + b.quantity; }, 0);
            var loadingEl = document.getElementById('loading');
            loadingEl.innerHTML = 'æ­£åœ¨è®¡ç®—æœ€ä¼˜æ–¹æ¡ˆ...<br><span style="font-size: 14px; opacity: 0.8;">å…± ' + totalBoxCount + ' ä¸ªç®±å­ï¼Œç­–ç•¥: ' + strategyNames[currentStrategy] + 'ï¼Œå§¿åŠ¿: ' + orientationNames[currentOrientation] + '</span>';
            loadingEl.classList.add('active');
            document.getElementById('results').style.display = 'none';
            document.getElementById('legend-panel').style.display = 'none';

            try {
                // ä½¿ç”¨ Web Worker å¼‚æ­¥è®¡ç®—ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
                var result = await packBoxesAsync(data.container, data.boxes, currentStrategy, currentOrientation);
                var packed = result.result;
                var duration = result.duration;
                
                // æ›´æ–°å…¨å±€å˜é‡
                placedBoxes = packed;
                
                // æ¸²æŸ“ç»“æœ
                visualizeResults(data.container, packed);
                displayResults(data.container, data.boxes, packed);
                
                // æ˜¾ç¤ºè®¡ç®—è€—æ—¶
                var durationSec = (duration / 1000).toFixed(2);
                console.log('[Web Worker] è£…ç®±è®¡ç®—å®Œæˆï¼Œç­–ç•¥: ' + currentStrategy + 'ï¼Œå§¿åŠ¿: ' + currentOrientation + 'ï¼Œè€—æ—¶: ' + durationSec + 'sï¼Œæ”¾ç½®äº† ' + packed.length + '/' + totalBoxCount + ' ä¸ªç®±å­');
                
                loadingEl.classList.remove('active');
            } catch (error) {
                console.error('Web Worker è®¡ç®—å¤±è´¥:', error);
                loadingEl.innerHTML = 'è®¡ç®—å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                loadingEl.classList.remove('active');
            }
        }

        // ==================== å¯¼å‡ºç»“æœ ====================
        // å…¨å±€å˜é‡ä¿å­˜å½“å‰å§¿åŠ¿
        var currentOrientationMode = 'free';
        
        function exportResults() {
            if (placedBoxes.length === 0) {
                alert('è¯·å…ˆè¿›è¡Œè®¡ç®—ï¼');
                return;
            }

            // å§¿åŠ¿åç§°æ˜ å°„
            var orientationNames = {
                'free': 'éšæ„æ‘†æ”¾',
                'upright': 'ç«‹æ”¾'
            };
            var currentOrientation = document.getElementById('orientation-mode').value;

            const data = getInputData();
            let text = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            text += '              3Dé›†è£…ç®±è£…ç®±æ–¹æ¡ˆæŠ¥å‘Š\n';
            text += '        ç­–ç•¥ï¼š' + strategyNames[currentStrategy] + '\n';
            text += '        å§¿åŠ¿ï¼š' + orientationNames[currentOrientation] + '\n';
            text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            
            text += `ã€é›†è£…ç®±å°ºå¯¸ã€‘\n`;
            text += `  é•¿ Ã— å®½ Ã— é«˜: ${data.container.length} Ã— ${data.container.width} Ã— ${data.container.height} cm\n\n`;
            
            text += `ã€è£…ç®±ç»Ÿè®¡ã€‘\n`;
            const boxCounts = {};
            placedBoxes.forEach(box => {
                boxCounts[box.id] = (boxCounts[box.id] || 0) + 1;
            });

            data.boxes.forEach(box => {
                const count = boxCounts[box.id] || 0;
                text += `  ${box.name} (${box.length}Ã—${box.width}Ã—${box.height}cm): ${count}/${box.quantity}\n`;
            });

            const containerVolume = (data.container.length * data.container.width * data.container.height) / 1000000;
            let usedVolume = 0;
            placedBoxes.forEach(box => {
                usedVolume += (box.length * box.width * box.height) / 1000000;
            });
            const utilizationRate = (usedVolume / containerVolume * 100).toFixed(2);

            text += `\nã€åˆ©ç”¨ç‡ç»Ÿè®¡ã€‘\n`;
            text += `  ç©ºé—´åˆ©ç”¨ç‡: ${utilizationRate}%\n`;
            text += `  é›†è£…ç®±å®¹ç§¯: ${containerVolume.toFixed(2)} mÂ³\n`;
            text += `  å·²ä½¿ç”¨å®¹ç§¯: ${usedVolume.toFixed(2)} mÂ³\n`;
            text += `  è£…è½½æ€»æ•°: ${placedBoxes.length}\n\n`;

            text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            text += '                    è¯¦ç»†æ‘†æ”¾ä½ç½®\n';
            text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            
            placedBoxes.forEach((box, index) => {
                text += `${String(index + 1).padStart(3, ' ')}. ${box.name}\n`;
                text += `     ä½ç½®: (${box.x}, ${box.y}, ${box.z})\n`;
                text += `     å°ºå¯¸: ${box.length} Ã— ${box.width} Ã— ${box.height} cm\n\n`;
            });

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'è£…ç®±æ–¹æ¡ˆ_' + new Date().toISOString().slice(0,10) + '.txt';
            a.click();
        }

        // ==================== æ§åˆ¶å‡½æ•° ====================
        function resetCamera() {
            const data = getInputData();
            const maxDim = Math.max(data.container.length, data.container.width, data.container.height);
            camera.position.set(maxDim * 1.5, maxDim * 1.2, maxDim * 1.5);
            controls.target.set(data.container.length / 2, data.container.height / 2, data.container.width / 2);
            controls.update();
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            boxMeshes.forEach(mesh => {
                mesh.material.wireframe = wireframeMode;
            });
        }

        function toggleAxes() {
            showAxes = !showAxes;
            if (axesHelper) {
                axesHelper.visible = showAxes;
            }
        }

        function toggleContainer() {
            showContainerBox = !showContainerBox;
            if (containerMesh) {
                containerMesh.visible = showContainerBox;
            }
        }

        // ==================== ä½¿ç”¨è¯´æ˜å¼¹çª— ====================
        function showHelp() {
            document.getElementById('help-modal').classList.add('visible');
        }

        function hideHelp() {
            document.getElementById('help-modal').classList.remove('visible');
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideHelp();
            }
        });

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            initScene();
            addBox();
            addBox();
            addBox();
        };
    </script>
</body>
</html>
